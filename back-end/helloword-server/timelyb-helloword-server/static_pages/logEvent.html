<!DOCTYPE html>
<html>
<head class="ui-mobile">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<!--    <link href="http://jquerymobile.com/demos/1.2.0/css/themes/default/jquery.mobile-1.2.0.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>

    <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.js" type="text/javascript"></script>
</head>
<body>
<div data-role="page" id="logEventPage">
    <div data-role="header">
        <h1>Log Event</h1>
    </div>
    <!-- /header -->
    <div data-role="content">
         <a id="selectEventActivityCode" href="javascript:gotoSelectActivity()" data-role="button"><span id="selectEventActivityCodeLabel">...</span></a>


        <input id="valueInput" name="value" type="text" value="1"/>
        <input id="startTimeIsoInput" name="startTime" type="hidden"/>
        <input id="endTimeIsoInput" name="endTime" type="hidden"/>
        <input id="commentInput" name="comment" type="text" placeholder="comment"/>

        <div data-role="controlgroup">
            <button data-role="button" id="checkInBtn">checkIn</button>
            <button data-role="button" id="checkOutBtn">checkOut</button>
        </div>

        <div><input id="submitBtn" type="submit" value="Submit Event"></div>

        <hr>
    </div>

    <div data-role="footer">
        <h4>Page Footer</h4>
    </div>
    <!-- /footer -->
</div>

<div data-role="page" data-url="pageEventSubmitResultPagePopup" id="pageEventSubmitResultPage" data-add-back-btn="true">
    <div data-role="header">
        <h1>My Title</h1>
    </div>
    <div data-role="content">
        event logged
    </div>
    <div data-role="footer">

    </div>
</div>


<div data-rel="popup" id="popupAlert">
    <div id="popupAlertContent">
        <p>This is a completely basic popup, no options set.

        <p>
    </div>
</div>

<div data-role="page" data-url="activityListPage" id="activityListPage" data-add-back-btn="true">
    <div data-role="header">
        <h1>Activities </h1>

        <a href="javascript:addNewActivity()" data-icon="add" class="ui-btn-right">Add</a>
    </div>
    <div data-role="content">
        <ul id="activitiesList" class="ui-listview ui-listview-inset ui-corner-all ui-shadow" data-inset="true" data-split-theme="b" data-theme="a" data-split-icon="plus" data-role="listview">
            <li><a href="acura.html">Acura</a></li>
        </ul>
    </div>


    <div data-role="footer">
        <h1></h1>
        <a href="javascript:refreshActivityListPage()" data-icon="refresh" class="ui-btn-right">Refresh</a>
    </div>
</div>


<div data-role="page" data-url="addActivityPage" id="addActivityPage" data-add-back-btn="true">
    <div data-role="header">
        <h1>Add Activity</h1>
        <a href="javascript:addActivity()" class="ui-btn-right" data-icon="check">Save</a>
    </div>
    <div data-role="content">
        <input id="newActivityId" placeholder="activity name" type="hidden"/>
        <input id="newActivityName" placeholder="activity name"/>
        <input id="newActivityDescription" placeholder="activity description"/>
        <input id="newActivityTags" placeholder="activity tags: box run sun"/>
        <input id="newActivityThumbUrl" placeholder="activity thumb url"/>
    </div>
    <div data-role="footer">

    </div>
</div>


<script id="activityItemTmpl" type="text/x-jquery-tmpl">

    <li class="ui-btn ui-btn-icon-right ui-li ui-li-has-alt ui-li-has-thumb ui-first-child ui-btn-up-d" data-corners="false" data-shadow="false" data-iconshadow="true" data-wrapperels="div" data-icon="false" data-iconpos="right" data-theme="d">

        <div class="ui-btn-inner ui-li ui-li-has-alt">
            <a href="javascript:selectActivity('${id}')"
               class="ui-link-inherit">
    <!--        <img src='${thumbUrl}' class="ui-li-thumb ui-corner-tl"/>-->

            <h3 class="ui-li-heading">${code}</h3>
            <p class="ui-li-desc">${name}</p>
            <p class="ui-li-desc">${tags}</p>
            </a>
        </div>

        <a class="ui-li-link-alt ui-btn ui-btn-icon-notext ui-btn-up-d" data-transition="slideup" data-rel="dialog"
           href="javascript:editActivityItem('${id}')" title="Edit Item" data-corners="false" data-shadow="false"
           data-iconshadow="true" data-wrapperels="span" data-icon="false" data-iconpos="notext" data-theme="d">
            <span class="ui-btn-inner">
            <span class="ui-btn-text"></span>
            <span class="ui-btn ui-btn-up-d ui-shadow ui-btn-corner-all ui-btn-icon-notext" data-corners="true" data-shadow="true"
                  data-iconshadow="true" data-wrapperels="span" data-icon="gear" data-iconpos="notext" data-theme="d" title="">
            <span class="ui-btn-inner">
            <span class="ui-btn-text"></span>
            <span class="ui-icon ui-icon-gear ui-icon-shadow"> </span>
            </span>
            </span>
            </span>
        </a>

    </li>

</script>
<script>
    var startDate, endDate;
    var selectedActivity = null;
    var activities = null;//[{title:'Пресс', hint:''} , {title:'Пилон'}];
    var activitiesById = null;//[{title:'Пресс', hint:''} , {title:'Пилон'}];
    jQuery(document).ready(function () {

        $("#popupAlert").popup()
    });

    $(document).on("pagebeforeshow", "#logEventPage", function () {
        initPage();
    });

    $(document).on("pagebeforeshow", "#activityListPage", function () {
        selectedActivity = null;
        refreshActivityListCtrl()
    });


    function addNewActivity() {
        $("#newActivityId").val('');
        $("#newActivityName").val('');
        $("#newActivityDescription").val('');
        $("#newActivityThumbUrl").val('');
        $("#newActivityTags").val('');
        $.mobile.changePage("#addActivityPage");
    }

    function addActivity() {
        console.log("submit");
        $.mobile.showPageLoadingMsg();
        $.ajax({
            url: "/service/event.addActivity",
            contentType: 'application/json; charset=utf-8',
            type: "POST",
            dataType: 'json',
            data: JSON.stringify({
                id: $("#newActivityId").val(),
                code: $("#newActivityName").val(),
                name: $("#newActivityDescription").val(),
                thumbUrl: $("#newActivityThumbUrl").val(),
                tags: $("#newActivityTags").val().replace(',', ' ').split(' ')
            }),
            success: function (data) {
                $.mobile.hidePageLoadingMsg();
                activities = null;
                gotoSelectActivity();
            },
            error: function (xhr, err) {
                $.mobile.hidePageLoadingMsg();
                alert(err);
            }
        });
    }

    function refreshActivityListCtrl() {
        $("#activitiesList").empty();
        $('#activityItemTmpl').tmpl(activities).appendTo('#activitiesList');
        $("#activitiesList").listview('refresh');
    }

    function refreshActivityListPage() {
        gotoSelectActivity(true);
    }

    function sortActivities(a, b) { // non-anonymous as you ordered...
        return b.code < a.code ?  1 // if b should come earlier, push a to end
             : b.code > a.code ? -1 // if b should come later, push a to begin
             : 0;                   // a and b are equal
    }

    function gotoSelectActivity(justRefresh) {
        if (activities == null || justRefresh) {
            $.mobile.showPageLoadingMsg();
            $.ajax({
                url: "/service/event.activities",
                contentType: 'application/json; charset=utf-8',
                type: "POST",
                dataType: 'json',
                data: JSON.stringify({
                }),
                success: function (data) {
                    $.mobile.hidePageLoadingMsg();

                    activities = data.items;
                    activitiesById = {};
                    activities.forEach(function (activity){
                        activitiesById[activity.id] = activity;
                    });
                    activities.sort();

                    if (justRefresh) {
                        refreshActivityListCtrl();
                    } else {
                        $.mobile.changePage("#activityListPage");
                    }
                },
                error: function (xhr, err) {
                    $.mobile.hidePageLoadingMsg();
                    alert(err);
                }
            });
        } else {
            $.mobile.changePage("#activityListPage");
        }

    }

    function editActivityItem(activityId) {
        activity = activitiesById[activityId]

        $("#newActivityId").val(activity.id);
        $("#newActivityName").val(activity.code);
        $("#newActivityDescription").val(activity.name);
        $("#newActivityThumbUrl").val(activity.thumbUrl);
        $("#newActivityTags").val(activity.tags.join(' '));
        $.mobile.changePage("#addActivityPage");
    }

    function selectActivity(activityId) {
        selectedActivity = activitiesById[activityId];
        console.log("selectActivity " + selectedActivity.code);
        $.mobile.changePage("#logEventPage");
        //$( "#activityInput").val(activity);
    }

    function alert(msg) {
        $("#popupAlertContent").html(msg);
        $("#popupAlert").popup().popup("open");
    }

    function initPage() {

        $("#selectEventActivityCodeLabel").html(selectedActivity ? selectedActivity.code : $("#selectEventActivityCode").html());

        $('#checkInBtn').button('enable');
        $('#checkOutBtn').button('disable');
        $('#submitBtn').button('disable');
        $('#commentInput').val('');
    }


    function getCurrentTime() {
        var date = new Date();
        return date.toLocaleTimeString();
    }

    function checkIn() {
        startDate = new Date().toISOString();
        $("#startTimeIsoInput").val(startDate);
        $("#startTimeInput").val(getCurrentTime());
        $('#checkInBtn').button('disable');
        $('#checkOutBtn').button('enable');
    }

    function checkOut() {
        endDate = new Date().toISOString();
        $("#endTimeIsoInput").val(endDate);
        $("#endTimeInput").val(getCurrentTime());
        $('#checkOutBtn').button('disable');
        $('#submitBtn').button('disable');

    }

    $("#checkInBtn").click(function (event) {
        checkIn();
        event.preventDefault();
    });

    $("#checkOutBtn").click(function (event) {
        checkOut();
        $('#submitBtn').button('enable');
        event.preventDefault();
    });

    $("#submitBtn").click(function () {
        console.log("submit");

        $.mobile.showPageLoadingMsg();

        $.ajax({
            url: "/service/event.add",
            contentType: 'application/json; charset=utf-8',
            type: "POST",
            dataType: 'json',
            data: JSON.stringify({
                activity: $("#activityInput").val(),
                comment: $("#commentInput").val(),
                value: $("#valueInput").val(),
                startTime: startDate,
                endTime: endDate
            }),
            success: function (data) {
                $.mobile.hidePageLoadingMsg();
                initPage();
                //$.mobile.changePage('#pageEventSubmitResultPagePopup');
            },
            error: function (xhr, err) {
                $.mobile.hidePageLoadingMsg();
                alert(err);
            }
        });
        return false;
    });


</script>

</body>

</html>